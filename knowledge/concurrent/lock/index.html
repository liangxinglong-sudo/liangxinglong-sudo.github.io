<!doctype html><html lang="zh-CN"><head><meta charset="utf-8" /><meta name="viewport" content="width=device-width,initial-scale=1" /><meta name="generator" content="VuePress 2.0.0-rc.20" /><meta name="theme" content="VuePress Theme Plume " /><script id="check-mac-os">document.documentElement.classList.toggle('mac', /Mac|iPhone|iPod|iPad/i.test(navigator.platform))</script><script id="check-dark-mode">;(function () {const um= localStorage.getItem('vuepress-theme-appearance') || 'auto';const sm = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;const isDark = um === 'dark' || (um !== 'light' && sm);document.documentElement.dataset.theme = isDark ? 'dark' : 'light';})();</script><meta property="og:url" content="https://liangxinglong-sudo.github.io/knowledge/concurrent/lock/"><meta property="og:site_name" content="coder liang"><meta property="og:title" content="Java 中的各种锁"><meta property="og:description" content="❎ synchronized的不足： 如果临界区是只读操作，其实可以多线程一起执行，但使用 synchronized 的话，同一时间只能有一个线程执行。 synchronized 无法知道线程有没有成功获取到锁。 使用 synchronized，如果临界区因为 IO 或者 sleep 方法等原因阻塞了，而当前线程又没有释放锁，就会导致所有线程等待。 临..."><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="article:tag" content="并发编程"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"Java 中的各种锁","image":[""],"dateModified":null,"author":[]}</script><link rel="icon" type="image/png" href="https://theme-plume.vuejs.press/favicon-32x32.png"><title>Java 中的各种锁 | coder liang</title><meta name="description" content="❎ synchronized的不足： 如果临界区是只读操作，其实可以多线程一起执行，但使用 synchronized 的话，同一时间只能有一个线程执行。 synchronized 无法知道线程有没有成功获取到锁。 使用 synchronized，如果临界区因为 IO 或者 sleep 方法等原因阻塞了，而当前线程又没有释放锁，就会导致所有线程等待。 临..."><link rel="preload" href="/assets/style-CcpaU1oG.css" as="style"><link rel="stylesheet" href="/assets/style-CcpaU1oG.css"><link rel="modulepreload" href="/assets/app-CpspcPOW.js"><link rel="modulepreload" href="/assets/index.html-BVpI36kb.js"></head><body><div id="app"><!--[--><!--[--><div class="theme-plume vp-layout" vp-container data-v-e2a85a92><!--[--><!--[--><!--]--><!--[--><span tabindex="-1" data-v-0d85e7f4></span><a href="#VPContent" class="vp-skip-link visually-hidden" data-v-0d85e7f4> Skip to content </a><!--]--><!----><header class="vp-nav" data-v-e2a85a92 data-v-e2eaa4d4><div class="vp-navbar" vp-navbar data-v-e2eaa4d4 data-v-d72d6f9b><div class="wrapper" data-v-d72d6f9b><div class="container" data-v-d72d6f9b><div class="title" data-v-d72d6f9b><div class="vp-navbar-title has-sidebar" data-v-d72d6f9b data-v-205b69c8><a class="vp-link no-icon link title" href="/" data-v-205b69c8 data-v-8faef36c><!--[--><!--[--><!--]--><!--[--><!--[--><!--[--><img class="vp-image dark logo" style="" src="https://theme-plume.vuejs.press/plume.png" alt data-v-f4386e50><!--]--><!--[--><img class="vp-image light logo" style="" src="https://theme-plume.vuejs.press/plume.png" alt data-v-f4386e50><!--]--><!--]--><!--]--><span data-v-205b69c8>coder liang</span><!--[--><!--]--><!--]--><!----></a></div></div><div class="content" data-v-d72d6f9b><div class="content-body" data-v-d72d6f9b><!--[--><!--]--><div class="vp-navbar-search search" data-v-d72d6f9b><div class="search-wrapper" data-v-c59534bd><!----><div id="local-search" data-v-c59534bd><button type="button" class="mini-search mini-search-button" aria-label="搜索文档" data-v-c59534bd><span class="mini-search-button-container"><span class="mini-search-search-icon vpi-mini-search" aria-label="search icon"></span><span class="mini-search-button-placeholder">搜索文档</span></span><span class="mini-search-button-keys"><kbd class="mini-search-button-key"></kbd><kbd class="mini-search-button-key">K</kbd></span></button></div></div></div><nav aria-labelledby="main-nav-aria-label" class="vp-navbar-menu menu" data-v-d72d6f9b data-v-a16403a0><span id="main-nav-aria-label" class="visually-hidden" data-v-a16403a0>Main Navigation</span><!--[--><!--[--><a class="vp-link no-icon link navbar-menu-link" href="/" tabindex="0" data-v-a16403a0 data-v-e9a2a996 data-v-8faef36c><!--[--><span class="vp-icon vpi-l8rjea8d" style="" data-v-e9a2a996 data-v-741d51ad></span><span data-v-e9a2a996>首页</span><!--]--><!----></a><!--]--><!--[--><a class="vp-link no-icon link navbar-menu-link" href="/knowledge/java/collection/" tabindex="0" data-v-a16403a0 data-v-e9a2a996 data-v-8faef36c><!--[--><span class="vp-icon vpi-8lmbp01u" style="" data-v-e9a2a996 data-v-741d51ad></span><span data-v-e9a2a996>练级</span><!--]--><!----></a><!--]--><!--[--><a class="vp-link no-icon link navbar-menu-link" href="/bookmark/" tabindex="0" data-v-a16403a0 data-v-e9a2a996 data-v-8faef36c><!--[--><span class="vp-icon vpi-t1l5w5tx" style="" data-v-e9a2a996 data-v-741d51ad></span><span data-v-e9a2a996>优秀文章收藏</span><!--]--><!----></a><!--]--><!--[--><a class="vp-link no-icon link navbar-menu-link" href="/notes/utils/log/" tabindex="0" data-v-a16403a0 data-v-e9a2a996 data-v-8faef36c><!--[--><span class="vp-icon vpi-kvx8irmx" style="" data-v-e9a2a996 data-v-741d51ad></span><span data-v-e9a2a996>工具类备份</span><!--]--><!----></a><!--]--><!--[--><a class="vp-link no-icon link navbar-menu-link" href="/notes/storys/view/" tabindex="0" data-v-a16403a0 data-v-e9a2a996 data-v-8faef36c><!--[--><span class="vp-icon vpi-ccsieksa" style="" data-v-e9a2a996 data-v-741d51ad></span><span data-v-e9a2a996>故事会</span><!--]--><!----></a><!--]--><!--]--></nav><!----><div class="vp-navbar-appearance appearance" data-v-d72d6f9b data-v-51d4779e><button class="vp-switch vp-switch-appearance" type="button" role="switch" title aria-checked="false" data-v-51d4779e data-v-ecae5613 data-v-58c1d8b1><span class="check" data-v-58c1d8b1><span class="icon" data-v-58c1d8b1><!--[--><span class="vpi-sun sun" data-v-ecae5613></span><span class="vpi-moon moon" data-v-ecae5613></span><!--]--></span></span></button></div><div class="vp-social-links vp-navbar-social-links social-links" data-v-d72d6f9b data-v-35aa5044 data-v-65bc2351><!--[--><a class="vp-social-link no-icon" href="/" aria-label="github" target="_blank" rel="noopener" data-v-65bc2351 data-v-04728ed0><span class="vpi-social-github" /></a><!--]--></div><div class="vp-flyout vp-navbar-extra extra" data-v-d72d6f9b data-v-9fcd43db data-v-fdb558f8><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-fdb558f8><span class="vpi-more-horizontal icon" data-v-fdb558f8></span></button><div class="menu" data-v-fdb558f8><div class="vp-menu" data-v-fdb558f8 data-v-b3129113><!----><!--[--><!--[--><!----><div class="group" data-v-9fcd43db><div class="item appearance" data-v-9fcd43db><p class="label" data-v-9fcd43db>外观</p><div class="appearance-action" data-v-9fcd43db><button class="vp-switch vp-switch-appearance" type="button" role="switch" title aria-checked="false" data-v-9fcd43db data-v-ecae5613 data-v-58c1d8b1><span class="check" data-v-58c1d8b1><span class="icon" data-v-58c1d8b1><!--[--><span class="vpi-sun sun" data-v-ecae5613></span><span class="vpi-moon moon" data-v-ecae5613></span><!--]--></span></span></button></div></div></div><div class="group" data-v-9fcd43db><div class="item social-links" data-v-9fcd43db><div class="vp-social-links social-links-list" data-v-9fcd43db data-v-65bc2351><!--[--><a class="vp-social-link no-icon" href="/" aria-label="github" target="_blank" rel="noopener" data-v-65bc2351 data-v-04728ed0><span class="vpi-social-github" /></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="vp-navbar-hamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="nav-screen" data-v-d72d6f9b data-v-d5861cf2><span class="container" data-v-d5861cf2><span class="top" data-v-d5861cf2></span><span class="middle" data-v-d5861cf2></span><span class="bottom" data-v-d5861cf2></span></span></button></div></div></div></div><div class="divider" data-v-d72d6f9b><div class="divider-line" data-v-d72d6f9b></div></div></div><!----></header><div class="vp-local-nav reached-top" data-v-e2a85a92 data-v-d3ed9cc5><button class="menu" aria-expanded="false" aria-controls="SidebarNav" data-v-d3ed9cc5><span class="vpi-align-left menu-icon" data-v-d3ed9cc5></span><span class="menu-text" data-v-d3ed9cc5>Menu</span></button><div class="vp-local-nav-outline-dropdown" style="--vp-vh:0px;" data-v-d3ed9cc5 data-v-f17542da><button data-v-f17542da>返回顶部</button><!----></div></div><aside class="vp-sidebar" vp-sidebar data-v-e2a85a92 data-v-dbadda69><div class="curtain" data-v-dbadda69></div><nav id="SidebarNav" class="nav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-dbadda69><span id="sidebar-aria-label" class="visually-hidden" data-v-dbadda69> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="no-transition group" data-v-3e83e6e6><section class="vp-sidebar-item sidebar-item level-0" data-v-3e83e6e6 data-v-584f9df0><div class="item" role="button" tabindex="0" data-v-584f9df0><div class="indicator" data-v-584f9df0></div><span class="vp-icon vpi-pewfyxrx bg" style="" data-v-584f9df0 data-v-741d51ad></span><h2 class="text" data-v-584f9df0>Java基础</h2><!----></div><div class="items" data-v-584f9df0><!--[--><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-584f9df0 data-v-584f9df0><div class="item" data-v-584f9df0><div class="indicator" data-v-584f9df0></div><span class="vp-icon vpi-r3ga6n1o" style="" data-v-584f9df0 data-v-741d51ad></span><a class="vp-link no-icon link link" href="/knowledge/java/collection/" data-v-584f9df0 data-v-8faef36c><!--[--><p class="text" data-v-584f9df0>Collection</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-584f9df0 data-v-584f9df0><div class="item" data-v-584f9df0><div class="indicator" data-v-584f9df0></div><span class="vp-icon vpi-gf4jnprk" style="" data-v-584f9df0 data-v-741d51ad></span><a class="vp-link no-icon link link" href="/knowledge/java/stream/" data-v-584f9df0 data-v-8faef36c><!--[--><p class="text" data-v-584f9df0>Stream</p><!--]--><!----></a><!----></div><!----></div><!--]--></div></section></div><div class="no-transition group" data-v-3e83e6e6><section class="vp-sidebar-item sidebar-item level-0" data-v-3e83e6e6 data-v-584f9df0><div class="item" role="button" tabindex="0" data-v-584f9df0><div class="indicator" data-v-584f9df0></div><span class="vp-icon vpi-xbk9pnk8 bg" style="" data-v-584f9df0 data-v-741d51ad></span><h2 class="text" data-v-584f9df0>常用框架</h2><!----></div><div class="items" data-v-584f9df0><!--[--><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-584f9df0 data-v-584f9df0><div class="item" data-v-584f9df0><div class="indicator" data-v-584f9df0></div><span class="vp-icon vpi-x1eb1swm" style="" data-v-584f9df0 data-v-741d51ad></span><a class="vp-link no-icon link link" href="/knowledge/frame/spring/" data-v-584f9df0 data-v-8faef36c><!--[--><p class="text" data-v-584f9df0>Spring</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-584f9df0 data-v-584f9df0><div class="item" data-v-584f9df0><div class="indicator" data-v-584f9df0></div><span class="vp-icon vpi-rr6e176h" style="" data-v-584f9df0 data-v-741d51ad></span><a class="vp-link no-icon link link" href="/knowledge/frame/mybatisPlus/" data-v-584f9df0 data-v-8faef36c><!--[--><p class="text" data-v-584f9df0>Mybatis-Plus</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-584f9df0 data-v-584f9df0><div class="item" data-v-584f9df0><div class="indicator" data-v-584f9df0></div><span class="vp-icon vpi-mdnfqdve" style="" data-v-584f9df0 data-v-741d51ad></span><a class="vp-link no-icon link link" href="/knowledge/frame/springRetry/" data-v-584f9df0 data-v-8faef36c><!--[--><p class="text" data-v-584f9df0>SpringRetry</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-584f9df0 data-v-584f9df0><div class="item" data-v-584f9df0><div class="indicator" data-v-584f9df0></div><span class="vp-icon vpi-f3oz9og7" style="" data-v-584f9df0 data-v-741d51ad></span><a class="vp-link no-icon link link" href="/knowledge/frame/netty/" data-v-584f9df0 data-v-8faef36c><!--[--><p class="text" data-v-584f9df0>Netty</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-584f9df0 data-v-584f9df0><div class="item" data-v-584f9df0><div class="indicator" data-v-584f9df0></div><span class="vp-icon vpi-di6cypfk" style="" data-v-584f9df0 data-v-741d51ad></span><a class="vp-link no-icon link link" href="/knowledge/frame/redission/" data-v-584f9df0 data-v-8faef36c><!--[--><p class="text" data-v-584f9df0>Redisson</p><!--]--><!----></a><!----></div><!----></div><!--]--></div></section></div><div class="no-transition group" data-v-3e83e6e6><section class="vp-sidebar-item sidebar-item level-0 has-active" data-v-3e83e6e6 data-v-584f9df0><div class="item" role="button" tabindex="0" data-v-584f9df0><div class="indicator" data-v-584f9df0></div><span class="vp-icon vpi-sdwh1ikk bg" style="" data-v-584f9df0 data-v-741d51ad></span><h2 class="text" data-v-584f9df0>并发编程</h2><!----></div><div class="items" data-v-584f9df0><!--[--><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-584f9df0 data-v-584f9df0><div class="item" data-v-584f9df0><div class="indicator" data-v-584f9df0></div><span class="vp-icon vpi-6f4grt0i" style="" data-v-584f9df0 data-v-741d51ad></span><a class="vp-link no-icon link link" href="/knowledge/concurrent/thread/" data-v-584f9df0 data-v-8faef36c><!--[--><p class="text" data-v-584f9df0>Java 中的线程</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-584f9df0 data-v-584f9df0><div class="item" data-v-584f9df0><div class="indicator" data-v-584f9df0></div><span class="vp-icon vpi-u778wgg3" style="" data-v-584f9df0 data-v-741d51ad></span><a class="vp-link no-icon link link" href="/knowledge/concurrent/thread-safe/" data-v-584f9df0 data-v-8faef36c><!--[--><p class="text" data-v-584f9df0>线程安全</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-584f9df0 data-v-584f9df0><div class="item" data-v-584f9df0><div class="indicator" data-v-584f9df0></div><span class="vp-icon vpi-2pa0eloc" style="" data-v-584f9df0 data-v-741d51ad></span><a class="vp-link no-icon link link" href="/knowledge/concurrent/lock/" data-v-584f9df0 data-v-8faef36c><!--[--><p class="text" data-v-584f9df0>Java 中的各种锁</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-584f9df0 data-v-584f9df0><div class="item" data-v-584f9df0><div class="indicator" data-v-584f9df0></div><span class="vp-icon vpi-qcerou9b" style="" data-v-584f9df0 data-v-741d51ad></span><a class="vp-link no-icon link link" href="/knowledge/concurrent/juc/" data-v-584f9df0 data-v-8faef36c><!--[--><p class="text" data-v-584f9df0>JUC 并发编程</p><!--]--><!----></a><!----></div><!----></div><!--]--></div></section></div><div class="no-transition group" data-v-3e83e6e6><section class="vp-sidebar-item sidebar-item level-0" data-v-3e83e6e6 data-v-584f9df0><div class="item" role="button" tabindex="0" data-v-584f9df0><div class="indicator" data-v-584f9df0></div><span class="vp-icon vpi-ehws67j3 bg" style="" data-v-584f9df0 data-v-741d51ad></span><h2 class="text" data-v-584f9df0>数据库</h2><!----></div><div class="items" data-v-584f9df0><!--[--><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-584f9df0 data-v-584f9df0><div class="item" data-v-584f9df0><div class="indicator" data-v-584f9df0></div><span class="vp-icon vpi-fl2n0s7m" style="" data-v-584f9df0 data-v-741d51ad></span><a class="vp-link no-icon link link" href="/knowledge/dbs/mysql/" data-v-584f9df0 data-v-8faef36c><!--[--><p class="text" data-v-584f9df0>MySQL</p><!--]--><!----></a><!----></div><!----></div><section class="vp-sidebar-item sidebar-item level-1 collapsible collapsed" data-v-584f9df0 data-v-584f9df0><div class="item" role="button" tabindex="0" data-v-584f9df0><div class="indicator" data-v-584f9df0></div><span class="vp-icon vpi-7q09vo6e" style="" data-v-584f9df0 data-v-741d51ad></span><h3 class="text" data-v-584f9df0>Oracle</h3><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-584f9df0><span class="vpi-chevron-right caret-icon" data-v-584f9df0></span></div></div><div class="items" data-v-584f9df0><!--[--><div class="vp-sidebar-item sidebar-item level-2 is-link" data-v-584f9df0 data-v-584f9df0><div class="item" data-v-584f9df0><div class="indicator" data-v-584f9df0></div><span class="vp-icon vpi-7q09vo6e" style="" data-v-584f9df0 data-v-741d51ad></span><a class="vp-link no-icon link link" href="/knowledge/dbs/oracle/oracle/" data-v-584f9df0 data-v-8faef36c><!--[--><p class="text" data-v-584f9df0>入门及概念</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-2 is-link" data-v-584f9df0 data-v-584f9df0><div class="item" data-v-584f9df0><div class="indicator" data-v-584f9df0></div><span class="vp-icon vpi-k7bkvqze" style="" data-v-584f9df0 data-v-741d51ad></span><a class="vp-link no-icon link link" href="/knowledge/dbs/oracle/oracle-ddl/" data-v-584f9df0 data-v-8faef36c><!--[--><p class="text" data-v-584f9df0>表操作语句</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-2 is-link" data-v-584f9df0 data-v-584f9df0><div class="item" data-v-584f9df0><div class="indicator" data-v-584f9df0></div><span class="vp-icon vpi-k7bkvqze" style="" data-v-584f9df0 data-v-741d51ad></span><a class="vp-link no-icon link link" href="/knowledge/dbs/oracle/oracle-dql/" data-v-584f9df0 data-v-8faef36c><!--[--><p class="text" data-v-584f9df0>查询语句及函数</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-2 is-link" data-v-584f9df0 data-v-584f9df0><div class="item" data-v-584f9df0><div class="indicator" data-v-584f9df0></div><span class="vp-icon vpi-k7bkvqze" style="" data-v-584f9df0 data-v-741d51ad></span><a class="vp-link no-icon link link" href="/knowledge/dbs/oracle/oracle-plsql/" data-v-584f9df0 data-v-8faef36c><!--[--><p class="text" data-v-584f9df0>sql编程</p><!--]--><!----></a><!----></div><!----></div><!--]--></div></section><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-584f9df0 data-v-584f9df0><div class="item" data-v-584f9df0><div class="indicator" data-v-584f9df0></div><span class="vp-icon vpi-ci8w603t" style="" data-v-584f9df0 data-v-741d51ad></span><a class="vp-link no-icon link link" href="/knowledge/dbs/redis/" data-v-584f9df0 data-v-8faef36c><!--[--><p class="text" data-v-584f9df0>Redis</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-584f9df0 data-v-584f9df0><div class="item" data-v-584f9df0><div class="indicator" data-v-584f9df0></div><span class="vp-icon vpi-8tch8j9v" style="" data-v-584f9df0 data-v-741d51ad></span><a class="vp-link no-icon link link" href="/knowledge/dbs/transcation/" data-v-584f9df0 data-v-8faef36c><!--[--><p class="text" data-v-584f9df0>数据库事务</p><!--]--><!----></a><!----></div><!----></div><!--]--></div></section></div><div class="no-transition group" data-v-3e83e6e6><section class="vp-sidebar-item sidebar-item level-0" data-v-3e83e6e6 data-v-584f9df0><div class="item" role="button" tabindex="0" data-v-584f9df0><div class="indicator" data-v-584f9df0></div><span class="vp-icon vpi-6hbpyd4g bg" style="" data-v-584f9df0 data-v-741d51ad></span><h2 class="text" data-v-584f9df0>开发组件</h2><!----></div><div class="items" data-v-584f9df0><!--[--><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-584f9df0 data-v-584f9df0><div class="item" data-v-584f9df0><div class="indicator" data-v-584f9df0></div><span class="vp-icon vpi-15vm9vpr" style="" data-v-584f9df0 data-v-741d51ad></span><a class="vp-link no-icon link link" href="/knowledge/component/docker/" data-v-584f9df0 data-v-8faef36c><!--[--><p class="text" data-v-584f9df0>Docker 容器</p><!--]--><!----></a><!----></div><!----></div><section class="vp-sidebar-item sidebar-item level-1 collapsible collapsed" data-v-584f9df0 data-v-584f9df0><div class="item" role="button" tabindex="0" data-v-584f9df0><div class="indicator" data-v-584f9df0></div><span class="vp-icon vpi-myoxos12" style="" data-v-584f9df0 data-v-741d51ad></span><h3 class="text" data-v-584f9df0>消息队列</h3><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-584f9df0><span class="vpi-chevron-right caret-icon" data-v-584f9df0></span></div></div><div class="items" data-v-584f9df0><!--[--><div class="vp-sidebar-item sidebar-item level-2 is-link" data-v-584f9df0 data-v-584f9df0><div class="item" data-v-584f9df0><div class="indicator" data-v-584f9df0></div><span class="vp-icon vpi-myoxos12" style="" data-v-584f9df0 data-v-741d51ad></span><a class="vp-link no-icon link link" href="/knowledge/component/mq/mq/" data-v-584f9df0 data-v-8faef36c><!--[--><p class="text" data-v-584f9df0>消息队列入门介绍</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-2 is-link" data-v-584f9df0 data-v-584f9df0><div class="item" data-v-584f9df0><div class="indicator" data-v-584f9df0></div><span class="vp-icon vpi-hfsp5mac" style="" data-v-584f9df0 data-v-741d51ad></span><a class="vp-link no-icon link link" href="/knowledge/component/mq/mq-noLess/" data-v-584f9df0 data-v-8faef36c><!--[--><p class="text" data-v-584f9df0>如何保证消息不丢失</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-2 is-link" data-v-584f9df0 data-v-584f9df0><div class="item" data-v-584f9df0><div class="indicator" data-v-584f9df0></div><span class="vp-icon vpi-in3mcf3w" style="" data-v-584f9df0 data-v-741d51ad></span><a class="vp-link no-icon link link" href="/knowledge/component/mq/mq-noMore/" data-v-584f9df0 data-v-8faef36c><!--[--><p class="text" data-v-584f9df0>如何处理重复消息</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-2 is-link" data-v-584f9df0 data-v-584f9df0><div class="item" data-v-584f9df0><div class="indicator" data-v-584f9df0></div><span class="vp-icon vpi-j3kbx77h" style="" data-v-584f9df0 data-v-741d51ad></span><a class="vp-link no-icon link link" href="/knowledge/component/mq/mq-order/" data-v-584f9df0 data-v-8faef36c><!--[--><p class="text" data-v-584f9df0>如何保证消息有序</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-2 is-link" data-v-584f9df0 data-v-584f9df0><div class="item" data-v-584f9df0><div class="indicator" data-v-584f9df0></div><span class="vp-icon vpi-huekjtz7" style="" data-v-584f9df0 data-v-741d51ad></span><a class="vp-link no-icon link link" href="/knowledge/component/mq/mq-backlog/" data-v-584f9df0 data-v-8faef36c><!--[--><p class="text" data-v-584f9df0>消息积压怎么办</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-2 is-link" data-v-584f9df0 data-v-584f9df0><div class="item" data-v-584f9df0><div class="indicator" data-v-584f9df0></div><span class="vp-icon vpi-k659y0js" style="" data-v-584f9df0 data-v-741d51ad></span><a class="vp-link no-icon link link" href="/knowledge/component/mq/mq-diy/" data-v-584f9df0 data-v-8faef36c><!--[--><p class="text" data-v-584f9df0>如何写个消息中间件</p><!--]--><!----></a><!----></div><!----></div><!--]--></div></section><section class="vp-sidebar-item sidebar-item level-1 collapsible collapsed" data-v-584f9df0 data-v-584f9df0><div class="item" role="button" tabindex="0" data-v-584f9df0><div class="indicator" data-v-584f9df0></div><span class="vp-icon vpi-y4i47tgk" style="" data-v-584f9df0 data-v-741d51ad></span><h3 class="text" data-v-584f9df0>分布式搜索</h3><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-584f9df0><span class="vpi-chevron-right caret-icon" data-v-584f9df0></span></div></div><div class="items" data-v-584f9df0><!--[--><div class="vp-sidebar-item sidebar-item level-2 is-link" data-v-584f9df0 data-v-584f9df0><div class="item" data-v-584f9df0><div class="indicator" data-v-584f9df0></div><span class="vp-icon vpi-fbxoeizq" style="" data-v-584f9df0 data-v-741d51ad></span><a class="vp-link no-icon link link" href="/knowledge/component/es/es/" data-v-584f9df0 data-v-8faef36c><!--[--><p class="text" data-v-584f9df0>搜索入门介绍</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-2 is-link" data-v-584f9df0 data-v-584f9df0><div class="item" data-v-584f9df0><div class="indicator" data-v-584f9df0></div><span class="vp-icon vpi-uo4chw5p" style="" data-v-584f9df0 data-v-741d51ad></span><a class="vp-link no-icon link link" href="/knowledge/component/es/es-install/" data-v-584f9df0 data-v-8faef36c><!--[--><p class="text" data-v-584f9df0>安装并练习使用</p><!--]--><!----></a><!----></div><!----></div><!--]--></div></section><!--]--></div></section></div><div class="no-transition group" data-v-3e83e6e6><section class="vp-sidebar-item sidebar-item level-0" data-v-3e83e6e6 data-v-584f9df0><div class="item" role="button" tabindex="0" data-v-584f9df0><div class="indicator" data-v-584f9df0></div><span class="vp-icon vpi-xabfb35o bg" style="" data-v-584f9df0 data-v-741d51ad></span><h2 class="text" data-v-584f9df0>数据结构</h2><!----></div><div class="items" data-v-584f9df0><!--[--><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-584f9df0 data-v-584f9df0><div class="item" data-v-584f9df0><div class="indicator" data-v-584f9df0></div><span class="vp-icon vpi-uxrldgrn" style="" data-v-584f9df0 data-v-741d51ad></span><a class="vp-link no-icon link link" href="/knowledge/dataStructure/array/" data-v-584f9df0 data-v-8faef36c><!--[--><p class="text" data-v-584f9df0>array</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-584f9df0 data-v-584f9df0><div class="item" data-v-584f9df0><div class="indicator" data-v-584f9df0></div><span class="vp-icon vpi-f1hz4dj9" style="" data-v-584f9df0 data-v-741d51ad></span><a class="vp-link no-icon link link" href="/knowledge/dataStructure/chain/" data-v-584f9df0 data-v-8faef36c><!--[--><p class="text" data-v-584f9df0>chain</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-584f9df0 data-v-584f9df0><div class="item" data-v-584f9df0><div class="indicator" data-v-584f9df0></div><span class="vp-icon vpi-6k8n7i26" style="" data-v-584f9df0 data-v-741d51ad></span><a class="vp-link no-icon link link" href="/knowledge/dataStructure/stack/" data-v-584f9df0 data-v-8faef36c><!--[--><p class="text" data-v-584f9df0>stack</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-584f9df0 data-v-584f9df0><div class="item" data-v-584f9df0><div class="indicator" data-v-584f9df0></div><span class="vp-icon vpi-6j91nivo" style="" data-v-584f9df0 data-v-741d51ad></span><a class="vp-link no-icon link link" href="/knowledge/dataStructure/tree/" data-v-584f9df0 data-v-8faef36c><!--[--><p class="text" data-v-584f9df0>tree</p><!--]--><!----></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><!--[--><div id="VPContent" vp-content class="vp-content has-sidebar" data-v-e2a85a92 data-v-f680e952><div class="vp-doc-container has-sidebar has-aside" data-v-f680e952 data-v-0c1b0d40><!--[--><!--]--><div class="container" data-v-0c1b0d40><div class="aside" vp-outline data-v-0c1b0d40><div class="aside-curtain" data-v-0c1b0d40></div><div class="aside-container" data-v-0c1b0d40><div class="aside-content" data-v-0c1b0d40><div class="vp-doc-aside" data-v-0c1b0d40 data-v-7f9316c5><!--[--><!--]--><!--[--><!--]--><nav aria-labelledby="doc-outline-aria-label" class="vp-doc-aside-outline" role="navigation" data-v-7f9316c5 data-v-1deb207d><div class="content" data-v-1deb207d><div class="outline-marker" data-v-1deb207d></div><div id="doc-outline-aria-label" aria-level="2" class="outline-title" role="heading" data-v-1deb207d><span data-v-1deb207d>此页内容</span><span class="vpi-print icon" data-v-1deb207d></span></div><ul class="root" data-v-1deb207d data-v-6af2c33d><!--[--><!--]--></ul></div></nav><!--[--><!--]--><div class="spacer" data-v-7f9316c5></div><!--[--><!--]--></div></div></div></div><div class="content" data-v-0c1b0d40><div class="content-container" data-v-0c1b0d40><!--[--><!--]--><main class="main" data-v-0c1b0d40><nav class="vp-breadcrumb" data-v-0c1b0d40 data-v-f0ee12f5><ol vocab="https://schema.org/" typeof="BreadcrumbList" data-v-f0ee12f5><!--[--><li property="itemListElement" typeof="ListItem" data-v-f0ee12f5><a class="vp-link no-icon link breadcrumb" href="/" property="item" typeof="WebPage" data-v-f0ee12f5 data-v-8faef36c><!--[-->首页<!--]--><!----></a><span class="vpi-chevron-right" data-v-f0ee12f5></span><meta property="name" content="首页" data-v-f0ee12f5><meta property="position" content="1" data-v-f0ee12f5></li><li property="itemListElement" typeof="ListItem" data-v-f0ee12f5><span class="vp-link no-icon breadcrumb" href="/" property="item" typeof="WebPage" data-v-f0ee12f5 data-v-8faef36c><!--[-->并发编程<!--]--><!----></span><span class="vpi-chevron-right" data-v-f0ee12f5></span><meta property="name" content="并发编程" data-v-f0ee12f5><meta property="position" content="2" data-v-f0ee12f5></li><li property="itemListElement" typeof="ListItem" data-v-f0ee12f5><a class="vp-link no-icon link breadcrumb current" href="/knowledge/concurrent/lock/" property="item" typeof="WebPage" data-v-f0ee12f5 data-v-8faef36c><!--[-->Java 中的各种锁<!--]--><!----></a><!----><meta property="name" content="Java 中的各种锁" data-v-f0ee12f5><meta property="position" content="3" data-v-f0ee12f5></li><!--]--></ol></nav><!--[--><h1 class="vp-doc-title page-title" data-v-48e8bd66>Java 中的各种锁 <!----></h1><div class="vp-doc-meta" data-v-48e8bd66><p class="reading-time" data-v-48e8bd66><span class="vpi-books icon" data-v-48e8bd66></span><span data-v-48e8bd66>约 4911 字</span><span data-v-48e8bd66>大约 16 分钟</span></p><!----><p class="create-time" data-v-48e8bd66><span class="vpi-clock icon" data-v-48e8bd66></span><span data-v-48e8bd66>2025-04-10</span></p></div><!--]--><div class="_knowledge_concurrent_lock_ external-link-icon-enabled vp-doc plume-content" vp-content data-v-0c1b0d40><div data-v-0c1b0d40><p>❎ <strong>synchronized的不足：</strong></p><ul><li><p>如果临界区是只读操作，其实可以多线程一起执行，但使用 synchronized 的话，<strong>同一时间只能有一个线程执行</strong>。</p></li><li><p>synchronized <strong>无法知道线程有没有成功获取到锁</strong>。</p></li><li><p>使用 synchronized，如果临界区因为 IO 或者 sleep 方法等原因阻塞了，而当前线程又没有释放锁，就<strong>会导致所有线程等待</strong>。</p></li></ul><div class="hint-container tip"><p class="hint-container-title">临界区（Critical Section）</p><p>临界区（Critical Section）是多线程中一个非常重要的概念，指的是<strong>在代码中访问共享资源的那部分，且同一时刻只能有一个线程能访问的代码</strong>。多个线程同时访问临界区的资源如果没有任何同步（加锁）操作，会导致资源的状态不可预测和不一致，从而产生所谓的“竞态条件”(Race Condition)。在许多并发控制策略中，例如互斥锁 synchronized，目标就是确保任何时候只有一个线程进入临界区。</p></div><p>不过，synchronized 的这些不足之处都可以通过 JUC 包下的其他锁来弥补，下面先来看一下锁的分类吧</p><h2 id="_1-锁的分类" tabindex="-1"><a class="header-anchor" href="#_1-锁的分类"><span>1. 锁的分类</span></a></h2><p><img src="/assets/lock%E5%88%86%E7%B1%BB-_R8H9ECC.png" alt="锁分类"></p><h2 id="_2-乐观锁-悲观锁" tabindex="-1"><a class="header-anchor" href="#_2-乐观锁-悲观锁"><span>2. 乐观锁 &amp; 悲观锁</span></a></h2><blockquote><p>乐观锁与悲观锁是一种广义上的概念，体现了看待线程同步的不同角度。在 Java 和数据库中都有此概念对应的实际应用。</p></blockquote><p>先说概念。对于同一个数据的并发操作，<strong>悲观锁认为自己在使用数据的时候一定有别的线程来修改数据，因此在获取数据的时候会先加锁，确保数据不会被别的线程修改</strong>。Java中，synchronized 关键字和 Lock 的实现类都是悲观锁。</p><p>而<strong>乐观锁认为自己在使用数据时不会有别的线程修改数据，所以不会添加锁，只是在更新数据的时候去判断之前有没有别的线程更新了这个数据</strong>。如果这个数据没有被更新，当前线程将自己修改的数据成功写入。如果数据已经被其他线程更新，则根据不同的实现方式执行不同的操作（例如报错或者自动重试）。</p><p>乐观锁在 Java 中是通过使用无锁编程来实现，最常采用的是 <strong>CAS 算法，Java 原子类中的递增操作就通过 CAS 自旋实现的</strong>。</p><p><img src="/assets/lock1-CsoWyCPJ.png" alt="乐观锁和悲观锁" width="942" height="725"></p><p>根据上面的概念描述我们可以发现：</p><ul><li><strong>悲观锁适合写操作多的场景，先加锁可以保证写操作时数据正确。</strong></li><li><strong>乐观锁适合读操作多的场景，不加锁的特点能够使其读操作的性能大幅提升。</strong></li></ul><p>光说概念有些抽象，我们来看下乐观锁和悲观锁的调用方式：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// --------- 悲观锁的调用方式 -------------------------</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// synchronized</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">public</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> synchronized</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> void</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> testMethod</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">()</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">	// 操作同步资源</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// ReentrantLock</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">private</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> ReentrantLock</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> lock</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> new</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> ReentrantLock</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">();</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// 需要保证多个线程使用的是同一个锁</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">public</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> void</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> modifyPublicResources</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">()</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">	lock</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">lock</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">();</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">	// 操作同步资源</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">	lock</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">unlock</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">();</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// --------- 乐观锁的调用方式 -------------------------</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">private</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> AtomicInteger</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> atomicInteger</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> new</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> AtomicInteger</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">();</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">  </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// 需要保证多个线程使用的是同一个AtomicInteger</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">atomicInteger</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">incrementAndGet</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">();</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> //执行自增1</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="什么是cas" tabindex="-1"><a class="header-anchor" href="#什么是cas"><span>✒️ 什么是CAS？</span></a></h3><p><strong>CAS的全称为 Compare-And-Swap，直译就是对比交换</strong>。是一条CPU的原子指令，其作用是让CPU先进行比较两个值是否相等，然后原子地更新某个位置的值，经过调查发现，<strong>其实现方式是基于硬件平台的汇编指令，就是说CAS是靠硬件实现的，JVM只是封装了汇编调用</strong>，那些AtomicInteger类便是使用了这些封装后的接口。   简单解释：<strong>CAS操作需要输入两个数值，一个旧值(期望操作前的值)和一个新值，在操作期间先比较下在旧值有没有发生变化，如果没有发生变化，才交换成新值，发生了变化则不交换</strong>。</p><p><strong>CAS操作是原子性的</strong>，所以多线程并发使用CAS更新数据时，可以不使用锁。JDK中大量使用了CAS来更新数据而防止加锁(synchronized 重量级锁)来保持原子更新。</p><p>相信sql大家都熟悉，<strong>类似sql中的条件更新一样</strong>：update set id=3 from table where id=2 因为单条sql执行具有原子性，如果有多个线程同时执行此sql语句，只有一条能更新成功。</p><p>在 CAS 中，有这样三个值：</p><ul><li>V：要更新的变量(var)</li><li>E：预期值(expected)</li><li>N：新值(new)</li></ul><p>比较并交换的过程如下：</p><ul><li>判断 V 是否等于 E，如果等于，将 V 的值设置为 N；如果不等，说明已经有其它线程更新了 V，于是当前线程放弃更新，什么都不做。</li></ul><blockquote><p>这里的预期值 E 本质上指的是“旧值”。</p></blockquote><p>我们以一个简单的例子来解释这个过程： <strong>如果有一个多个线程共享的变量 i 原本等于 5，我现在在线程 A 中，想把它设置为新的值 6</strong>。在这个例子中，i 就是 V，5 就是 E，6 就是 N。</p><ul><li>首先我们用 i 去与 5 对比，发现它等于 5，说明没有被其它线程改过，那我就把它设置为新的值 6，此次 CAS 成功，i的值被设置成了 6；</li><li>如果不等于 5，说明i被其它线程改过了（比如现在i的值为 2），那么我就什么也不做，此次 CAS 失败，i的值仍然为 2。</li></ul><p>那有没有可能我在判断了 i 为 5 之后，正准备更新它的新值的时候，被其它线程更改了 i 的值呢？</p><p>不会的。因为 <strong>CAS 是一种原子操作，它是一种系统原语，是一条 CPU 的原子指令，从 CPU 层面已经保证它的原子性</strong>。</p><p><strong>当多个线程同时使用 CAS 操作一个变量时，只有一个会胜出，并成功更新，其余均会失败，但失败的线程并不会被挂起，仅是被告知失败，并且允许再次尝试，当然也允许失败的线程放弃操作</strong>。</p><h3 id="unsafe-和-cas-的关系" tabindex="-1"><a class="header-anchor" href="#unsafe-和-cas-的关系"><span>✒️ Unsafe 和 CAS 的关系</span></a></h3><p>Java 中为我们提供了 AtomicInteger 原子类(底层基于 CAS 进行更新数据的)，不需要加锁就在多线程并发场景下实现数据的一致性。而 Java 原子类是通过 UnSafe 类实现的。<strong>Unsafe 的实现是通过 C++ 实现的，它的具体实现和操作系统、CPU 都有关系</strong>。</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">/**</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> * An {@code int} value that may be updated atomically.  See the</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> * {@link java.util.concurrent.atomic} package specification for</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> * description of the properties of atomic variables. An</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> * {@code AtomicInteger} is used in applications such as atomically</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> * incremented counters, and cannot be used as a replacement for an</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> * {@link java.lang.Integer}. However, this class does extend</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> * {@code Number} to allow uniform access by tools and utilities that</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> * deal with numerically-based classes.</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> *</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> * </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">@since</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> 1.5</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> * </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">@author</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> Doug Lea</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">*/</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">public</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> class</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> AtomicInteger</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> extends</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> Number</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> implements</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> java.io.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Serializable</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    private</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> static</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> final</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> long</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> serialVersionUID</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 6214790243416807050L</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // setup to use Unsafe.compareAndSwapInt for updates</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    private</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> static</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> final</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> Unsafe</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> unsafe</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> Unsafe</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">getUnsafe</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">();</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    private</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> static</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> final</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> long</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> valueOffset</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    static</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">        try</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">            valueOffset </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> unsafe</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">objectFieldOffset</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">                (</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">AtomicInteger</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">class</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">getDeclaredField</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">value</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">));</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">        }</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> catch</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">Exception </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">ex</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> throw</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> new</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> Error</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">ex</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> }</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    private</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> volatile</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> int</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> value</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">	...</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="cas-的-aba-问题" tabindex="-1"><a class="header-anchor" href="#cas-的-aba-问题"><span>✒️ CAS 的 ABA 问题</span></a></h3><p>因为CAS需要在操作值的时候，检查值有没有发生变化，比如没有发生变化则更新，但是<strong>如果一个值原来是A，变成了B，又变成了A，那么使用CAS进行检查时则会发现它的值没有发生变化，但是实际上却变化了</strong>。</p><p>ABA问题的解决思路就是使用版本号。在变量前面追加上版本号，每次变量更新的时候把版本号加1，那么A-&gt;B-&gt;A就会变成1A-&gt;2B-&gt;3A。</p><p>从 Java 1.5 开始，JDK的 Atomic 包里提供了一个类 AtomicStampedReference 来解决 ABA 问题这个类的 compareAndSet 方法的作用是<strong>首先检查当前引用是否等于预期引用，并且检查当前标志是否等于预期标志，如果全部相等，则以原子方式将该引用和该标志的值设置为给定的更新值</strong>。</p><h3 id="cas-的-长时间自旋-问题" tabindex="-1"><a class="header-anchor" href="#cas-的-长时间自旋-问题"><span>✒️ CAS 的 长时间自旋 问题</span></a></h3><p>CAS 多与自旋结合。如果自旋 CAS 长时间不成功，会占用大量的 CPU 资源。</p><p>解决思路是让 JVM 支持处理器提供的pause 指令。</p><p>pause 指令能让自旋失败时 cpu 睡眠一小段时间再继续自旋，从而使得读操作的频率降低很多，为解决内存顺序冲突而导致的 CPU 流水线重排的代价也会小很多</p><h3 id="cas-的-多个共享变量的原子操作-问题" tabindex="-1"><a class="header-anchor" href="#cas-的-多个共享变量的原子操作-问题"><span>✒️ CAS 的 多个共享变量的原子操作 问题</span></a></h3><p>当对一个共享变量执行操作时，CAS 能够保证该变量的原子性。但是对于多个共享变量，CAS 就无法保证操作的原子性，这时通常有两种做法：</p><ol><li>使用AtomicReference类保证对象之间的原子性，把多个变量放到一个对象里面进行 CAS 操作；</li><li>使用锁。锁内的临界区代码可以保证只有当前线程能操作。</li></ol><h2 id="_3-自旋锁-适应性自旋锁" tabindex="-1"><a class="header-anchor" href="#_3-自旋锁-适应性自旋锁"><span>3.自旋锁 &amp; 适应性自旋锁</span></a></h2><p><strong>阻塞或唤醒一个Java线程需要操作系统切换CPU状态来完成，这种状态转换需要耗费处理器时间</strong>。如果同步代码块中的内容过于简单，状态转换消耗的时间有可能比用户代码执行的时间还要长。</p><p>在许多场景中，同步资源的锁定时间很短，为了这一小段时间去切换线程，线程挂起和恢复现场的花费可能会让系统得不偿失。如果物理机器有多个处理器，能够让两个或以上的线程同时并行执行，我们就可以让后面那个请求锁的线程不放弃CPU的执行时间，看看持有锁的线程是否很快就会释放锁。</p><p>而<strong>为了让当前线程“稍等一下”，我们需让当前线程进行自旋</strong>，如果在自旋完成后前面锁定同步资源的线程已经释放了锁，那么当前线程就可以不必阻塞而是直接获取同步资源，从而避免切换线程的开销。这就是自旋锁。</p><p><img src="/assets/%E8%87%AA%E6%97%8B%E9%94%81-BgXzdAwb.png" alt="自旋锁"></p><p>自旋锁本身是有缺点的，它不能代替阻塞。自旋等待虽然避免了线程切换的开销，但它要占用处理器时间。如果锁被占用的时间很短，自旋等待的效果就会非常好。反之，如果锁被占用的时间很长，那么自旋的线程只会白浪费处理器资源。所以，<strong>自旋等待的时间必须要有一定的限度，如果自旋超过了限定次数（默认是10次，可以使用-XX:PreBlockSpin来更改）没有成功获得锁，就应当挂起线程</strong>。</p><p><strong>自旋锁的实现原理同样也是CAS，AtomicInteger中调用unsafe进行自增操作的源码中的do-while循环就是一个自旋操作</strong>，如果修改数值失败则通过循环来执行自旋，直至修改成功。</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">	/**</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">     * Atomically increments by one the current value.</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">     *</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">     * </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">@return</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> the previous value</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">     */</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    public</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> final</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> int</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> getAndIncrement</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">()</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">		//我们查看 AtomicInteger 的自增方法incrementAndGet()</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">		//发现自增方法底层调用的是unsafe.getAndAddInt()</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">        return</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> unsafe</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">getAndAddInt</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> valueOffset</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">	public</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> final</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> int</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> getAndAddInt</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">Object var1</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> long</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> var2</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> int</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> var4</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">        int</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> var5</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">        do</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">            var5 </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">getIntVolatile</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">var1</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> var2</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">        }</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> while</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">!</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">compareAndSwapInt</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">var1</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> var2</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> var5</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> var5 </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">+</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> var4</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">));</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">        return</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> var5</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>根据源码我们可以看出，整个“比较+更新”操作都封装在compareAndSwapInt()中，在 JNI 里是借助于一个 CPU 指令完成的，属于原子操作，可以保证多个线程都能够看到同一个变量的修改值。</p><div class="hint-container tip"><p class="hint-container-title">提示</p><p>Java Native Interface（JNI）是Java与本地代码（如C、C++）之间的 桥梁。它允许Java代码与原生应用程序的接口（API）和本地库进行交互，并获得一些Java不能轻松完成任务的能力。</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">public</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> final</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> native</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> boolean</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> compareAndSwapInt</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">Object var1</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> long</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> var2</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> int</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> var4</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> int</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> var5</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></div><p>自旋锁在 JDK1.4.2 中引入，使用-XX:+UseSpinning来开启。JDK 6 中变为默认开启，并且引入了<strong>自适应的自旋锁（适应性自旋锁）</strong>。</p><p><strong>自适应意味着自旋的时间（次数）不再固定，而是由前一次在同一个锁上的自旋时间及锁的拥有者的状态来决定</strong>。如果在同一个锁对象上，自旋刚刚成功获得过锁，并且持有锁的线程正在运行中，那么虚拟机就会认为这次自旋也是很有可能再次成功的，进而它将允许自旋等待更长的时间。如果对于某个锁，自旋很少成功获得过，那在以后尝试获取这个锁时将可能省略掉自旋过程，直接阻塞线程，避免浪费处理器资源。</p><h2 id="_4-无锁-偏向锁-轻量级锁-重量级锁" tabindex="-1"><a class="header-anchor" href="#_4-无锁-偏向锁-轻量级锁-重量级锁"><span>4. 无锁 &amp; 偏向锁 &amp; 轻量级锁 &amp; 重量级锁</span></a></h2><p>这四种锁是指锁的状态，专门针对synchronized的，我们在<a class="route-link" href="/notes/knowledge/3.concurrent/thread-safe.html#%E4%B8%89%E3%80%81synchronized-%E5%85%B3%E9%94%AE%E5%AD%97">synchronized-关键字</a> 之前已经提过。</p><p>偏向锁通过对比Mark Word解决加锁问题，避免执行CAS操作。而轻量级锁是通过用CAS操作和自旋来解决加锁问题，避免线程阻塞和唤醒而影响性能。重量级锁是将除了拥有锁的线程以外的线程都阻塞。</p><h2 id="_5-可重入锁-非可重入锁" tabindex="-1"><a class="header-anchor" href="#_5-可重入锁-非可重入锁"><span>5. 可重入锁 &amp; 非可重入锁</span></a></h2><p>可重入锁又名递归锁，是指<strong>同一个线程在外层方法获取锁的时候，再进入该线程的内层方法会自动获取锁（前提：锁的是同一个对象或者 class），不会因为之前已经获取过还没释放而阻塞</strong>。Java 中ReentrantLock 和 synchronized 都是可重入锁，可重入锁的一个优点就是可以一定程度避免死锁。下面用示例代码来进行分析：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">public</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> class</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Widget</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    public</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> synchronized</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> void</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> doSomething</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">()</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">        System</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">out</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">println</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">方法1执行...</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        doOthers</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">();</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    public</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> synchronized</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> void</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> doOthers</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">()</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">        System</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">out</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">println</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">方法2执行...</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>类中的两个方法都是被内置锁 synchronized 修饰的，doSomething() 方法中调用了doOthers()方法。因为<strong>内置锁是可重入的，所以同一个线程在调用 doOthers() 时可以直接获得当前对象的锁，进入doOthers() 进行操作</strong>。</p><p>如果是一个<strong>不可重入锁，那么当前线程在调用 doOthers() 之前，需要将执行 doSomething() 时获取当前对象的锁释放掉，实际上该对象锁已经被当前线程所持有，且无法释放。所以此时会出现死锁</strong>。</p><p>之前我们说过 ReentrantLock 和 synchronized 都是重入锁，那么我们看下重入锁 ReentrantLock 的源码。</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">public</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> class</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> ReentrantLock</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> implements</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> Lock</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> java.io.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Serializable</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    private</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> static</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> final</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> long</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> serialVersionUID</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 7373984872572414699L</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    private</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> final</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> Sync</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> sync</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">	//首先ReentrantLock和 NonReentrantLock 都继承了父类AQS，</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">	//其父类 AQS 中维护了一个同步状态 status 来计数重入次数，status 初始值为 0。</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">	abstract</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> static</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> class</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Sync</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> extends</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> AbstractQueuedSynchronizer</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">	    private</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> static</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> final</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> long</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> serialVersionUID</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> -</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">5179523762034025860L</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">	    </span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">	    abstract</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> void</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> lock</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">	    </span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">	    final</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> boolean</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> nonfairTryAcquire</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">int</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> acquires</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">	        final</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> Thread</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> current</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> Thread</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">currentThread</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">();</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">			</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">			//当线程尝试获取锁时，可重入锁先尝试获取并更新 status 值</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">	        int</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> c</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> getState</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">();</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">			</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">			//如果status == 0表示没有其他线程在执行同步代码，则把 status 置为 1，当前线程开始执行。</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">	        if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">c </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">==</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 0</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">	            if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">compareAndSetState</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">0</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> acquires</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">))</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">	                setExclusiveOwnerThread</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">current</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">	                return</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> true</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">	            }</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">	        }</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">			//获取锁时先判断，如果当前线程就是已经获取所得线程</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">			//则state+1，并返回true</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">	        else</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">current </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">==</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> getExclusiveOwnerThread</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">())</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">	            int</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> nextc</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> c </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">+</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> acquires</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">	            if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">nextc </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">&lt;</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 0</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> // overflow</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">	                throw</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> new</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> Error</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Maximum lock count exceeded</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">	            setState</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">nextc</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">	            return</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> true</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">	        }</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">	        return</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> false</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">	    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">		//释放锁时也先判断当前线程是否是已经获取锁的线程，在判断state。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">		//如果status-1 == 0，则表示当前线程所有重复获取锁的操作都已经执行完毕，然后该线程才会真正释放锁。</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">	    protected</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> final</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> boolean</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> tryRelease</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">int</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> releases</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">	        int</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> c</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> getState</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">()</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> -</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> releases</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">	        if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">Thread</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">currentThread</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">()</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> !=</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> getExclusiveOwnerThread</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">())</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">	            throw</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> new</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> IllegalMonitorStateException</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">();</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">	        boolean</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> free</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> false</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">	        if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">c </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">==</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 0</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">	            free </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> true</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">	            setExclusiveOwnerThread</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">null</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">	        }</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">	        setState</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">c</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">	        return</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> free</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">	    }</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">	}</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">	</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_6-公平锁与非公平锁" tabindex="-1"><a class="header-anchor" href="#_6-公平锁与非公平锁"><span>6.公平锁与非公平锁</span></a></h2><p><strong>公平锁是指多个线程按照申请锁的顺序来获取锁</strong>，线程直接进入队列中排队，队列中的第一个线程才能获得锁。公平锁的优点是等待锁的线程不会饿死。缺点是整体吞吐效率相对非公平锁要低，等待队列中除第一个线程以外的所有线程都会阻塞，CPU唤醒阻塞线程的开销比非公平锁大。</p><p><strong>非公平锁是多个线程加锁时直接尝试获取锁，获取不到才会到等待队列的队尾等待</strong>。但如果此时锁刚好可用，那么这个线程可以无需阻塞直接获取到锁，所以非公平锁有可能出现后申请锁的线程先获取锁的场景。非公平锁的优点是可以减少唤起线程的开销，整体的吞吐效率高，因为线程有几率不阻塞直接获得锁，CPU不必唤醒所有线程。<strong>缺点是处于等待队列中的线程可能会饿死，或者等很久才会获得锁</strong>。ReentrantLock 默认非公平锁，可以在构造方法中传参切换公平锁还是非公平锁。</p><h2 id="_7-独享锁-排他锁-vs-共享锁" tabindex="-1"><a class="header-anchor" href="#_7-独享锁-排他锁-vs-共享锁"><span>7.独享锁(排他锁) VS 共享锁</span></a></h2><p>排他锁/独享锁/互斥锁：是指该锁一次只能被一个线程所持有。如果线程T对数据A加上排它锁后，则其他线程不能再对A加任何类型的锁。获得排它锁的线程即能读数据又能修改数据。前面讲到的 synchronized 和 ReentrantLock，其实都是“排它锁”。也就是说，<strong>这些锁在同一时刻只允许一个线程进行访问</strong>。</p><p>共享锁/读写锁：是指<strong>该锁可被多个线程所持有</strong>。如果线程T对数据A加上共享锁后，则其他线程只能对A再加共享锁，不能加排它锁。获得共享锁的线程<strong>只能读数据，不能修改数据</strong>。</p><p>读写锁可以在同一时刻允许多个读线程访问。Java 提供了 ReentrantReadWriteLock 类作为读写锁的默认实现，内部维护了两个锁：一个读锁，一个写锁。通过分离读锁和写锁，使得在 “读多写少” 的环境下，大大地提高了性能。<strong>注意，即使用读写锁，在写线程访问时，所有的读线程和其它写线程均被阻塞。</strong></p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">public</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> class</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> ReentrantReadWriteLock</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> implements</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> ReadWriteLock</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> java.io.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Serializable</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">	/** 内部类读锁 */</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    private</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> final</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> ReentrantReadWriteLock</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">ReadLock</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> readerLock</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">	/** 内部类写锁 */</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    private</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> final</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> ReentrantReadWriteLock</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">WriteLock</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> writerLock</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    final</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> Sync</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> sync</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    public</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> ReentrantReadWriteLock</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">boolean</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> fair</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        sync </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> fair </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">?</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> new</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> FairSync</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">()</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> :</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> new</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> NonfairSync</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">();</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        readerLock </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> new</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> ReadLock</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        writerLock </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> new</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> WriteLock</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    public</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> ReentrantReadWriteLock</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">WriteLock </span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">writeLock</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">()</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> return</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> writerLock</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> }</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    public</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> ReentrantReadWriteLock</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">ReadLock  </span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">readLock</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">()</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">  {</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> return</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> readerLock</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">	...</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>独享锁与共享锁也是通过 AQS 来实现的，通过实现不同的方法，来实现独享或者共享。</p><p>进一步观察可以发现 ReadLock 和 WriteLock 是靠内部类 Sync 实现的锁。Sync 是 AQS 的一个子类，这种结构在 CountDownLatch、Semaphore、ReentrantLock 里面也都存在。</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">abstract</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> static</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> class</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Sync</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> extends</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> AbstractQueuedSynchronizer</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">	...</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">//写锁</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">public</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> static</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> class</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> WriteLock</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> implements</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> Lock</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> java.io.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Serializable</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    private</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> static</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> final</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> long</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> serialVersionUID</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> -</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">4992448646407690164L</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    private</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> final</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> Sync</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> sync</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    /**</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">     * Constructor for use by subclasses</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">     *</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">     * </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">@param</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> lock</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> the outer lock object</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">     * </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">@throws</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> NullPointerException</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> if the lock is null</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">     */</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    protected</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> WriteLock</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">ReentrantReadWriteLock </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">lock</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        sync </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> lock</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">sync</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">//读锁</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">public</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> static</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> class</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> ReadLock</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> implements</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> Lock</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> java.io.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Serializable</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    private</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> static</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> final</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> long</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> serialVersionUID</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> -</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">5992448646407690164L</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    private</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> final</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> Sync</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> sync</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    /**</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">     * Constructor for use by subclasses</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">     *</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">     * </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">@param</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> lock</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> the outer lock object</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">     * </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">@throws</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> NullPointerException</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> if the lock is null</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">     */</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    protected</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> ReadLock</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">ReentrantReadWriteLock </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">lock</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        sync </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> lock</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">sync</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><!----><!----><!----></div></main><footer class="vp-doc-footer" data-v-0c1b0d40 data-v-ed4033a5><!--[--><!--]--><!----><!----><nav class="prev-next" data-v-ed4033a5><div class="pager" data-v-ed4033a5><a class="vp-link no-icon link pager-link prev" href="/knowledge/concurrent/thread-safe/" data-v-ed4033a5 data-v-8faef36c><!--[--><span class="desc" data-v-ed4033a5>上一页</span><span class="title" data-v-ed4033a5>线程安全</span><!--]--><!----></a></div><div class="pager" data-v-ed4033a5><a class="vp-link no-icon link pager-link next" href="/knowledge/concurrent/juc/" data-v-ed4033a5 data-v-8faef36c><!--[--><span class="desc" data-v-ed4033a5>下一页</span><span class="title" data-v-ed4033a5>JUC 并发编程</span><!--]--><!----></a></div></nav></footer><!----><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><!--]--><button style="display:none;" type="button" class="vp-back-to-top" aria-label="back to top" data-v-e2a85a92 data-v-f652afe6><span class="percent" data-allow-mismatch data-v-f652afe6>0%</span><span class="show icon vpi-back-to-top" data-v-f652afe6></span><svg aria-hidden="true" data-v-f652afe6><circle cx="50%" cy="50%" data-allow-mismatch style="stroke-dasharray:calc(0% - 12.566370614359172px) calc(314.1592653589793% - 12.566370614359172px);" data-v-f652afe6></circle></svg></button><footer class="vp-footer has-sidebar" vp-footer data-v-e2a85a92 data-v-90f83487><!--[--><div class="container" data-v-90f83487><p class="message" data-v-90f83487>Power by <a target="_blank" href="https://v2.vuepress.vuejs.org/">VuePress</a> & <a target="_blank" href="https://theme-plume.vuejs.press">vuepress-theme-plume</a></p><!----></div><!--]--></footer><!--[--><!--]--><!--]--></div><!----><!--]--><!--[--><!--]--><!--]--></div><script type="module" src="/assets/app-CpspcPOW.js" defer></script></body></html>